<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Swarm v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #050505;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(20, 20, 25, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }
    </style>
</head>

<body class="bg-[#050505] h-screen text-slate-200 overflow-hidden">
    <div x-data="swarmApp()" x-init="init()" class="flex h-full w-full">

        <!-- SIDEBAR: LOGS -->
        <aside class="w-80 bg-[#0a0a0a] border-r border-[#1a1a1a] flex flex-col z-20">
            <div class="p-6 border-b border-[#1a1a1a]">
                <h1
                    class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent neon-text">
                    Neural Swarm</h1>
                <p class="text-[10px] text-slate-600 mt-1 uppercase tracking-widest">Autonomous Video Orchestration</p>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-[10px]" id="log-container">
                <template x-for="log in logs">
                    <div class="p-2 rounded border border-l-2 bg-[#0f0f0f] border-[#1a1a1a]" :class="{
                        'border-l-purple-500': log.type === 'agent', 
                        'border-l-green-500': log.type === 'success',
                        'border-l-red-500': log.type === 'error'
                     }">
                        <span class="text-slate-500 mr-2" x-text="log.timestamp"></span>
                        <span x-text="log.message"
                            :class="{'text-purple-300': log.type === 'agent', 'text-green-300': log.type === 'success'}"></span>
                    </div>
                </template>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col relative overflow-hidden">
            <!-- Background Grid -->
            <div
                class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:40px_40px]">
            </div>

            <!-- TOP BAR -->
            <div
                class="h-16 border-b border-[#1a1a1a] flex items-center justify-between px-8 bg-[#0a0a0a]/80 backdrop-blur z-10">
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-2">
                        <button @click="view = 'swarm'"
                            :class="view === 'swarm' ? 'text-purple-400 border-b-2 border-purple-500' : 'text-slate-500 hover:text-slate-300'"
                            class="px-4 py-4 text-xs font-bold uppercase tracking-widest transition-all">
                            üöÄ Dashboard
                        </button>
                        <button @click="view = 'library'; loadProjects()"
                            :class="view === 'library' ? 'text-purple-400 border-b-2 border-purple-500' : 'text-slate-500 hover:text-slate-300'"
                            class="px-4 py-4 text-xs font-bold uppercase tracking-widest transition-all">
                            üìö Library
                        </button>
                        <button @click="view = 'settings'; loadSettings()"
                            :class="view === 'settings' ? 'text-purple-400 border-b-2 border-purple-500' : 'text-slate-500 hover:text-slate-300'"
                            class="px-4 py-4 text-xs font-bold uppercase tracking-widest transition-all">
                            ‚öôÔ∏è Settings
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-4 w-1/3" x-show="view === 'swarm'">
                    <input type="text" x-model="niche"
                        class="w-full bg-[#151515] border border-[#2a2a2a] rounded px-4 py-2 text-sm focus:border-purple-500 outline-none transition-colors"
                        placeholder="Enter Niche (e.g., 'Space Exploration')">
                    <button @click="startSwarm()" :disabled="processing"
                        class="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded text-sm font-bold shadow-[0_0_15px_rgba(168,85,247,0.4)] transition-all disabled:opacity-50">
                        <span x-show="!processing">IGNITE</span>
                        <span x-show="processing" class="animate-spin text-lg">üåÄ</span>
                    </button>
                </div>
            </div>

            <!-- VIEW: SWARM DASHBOARD -->
            <div x-show="view === 'swarm'" class="flex-1 p-6 overflow-x-auto overflow-y-hidden" x-transition>
                <div class="h-full flex items-center justify-center p-8">
                    <!-- Progress Centralized View -->
                    <div class="grid grid-cols-5 gap-6 w-full max-w-7xl h-full">
                        <!-- DEPT 1: STRATEGY -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-2 h-2 rounded-full bg-purple-500 animate-pulse"></div>
                                <span
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Strategy</span>
                            </div>
                            <!-- Steps -->
                            <div class="space-y-3">
                                <div :class="data.trends ? 'glass p-4 rounded-xl border-purple-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Trends</div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.trends ? '‚úÖ Analysis Done' : 'Waiting...'"></div>
                                </div>
                                <div :class="data.audience_profile ? 'glass p-4 rounded-xl border-purple-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Audience
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.audience_profile ? '‚úÖ Profiled' : 'Waiting...'"></div>
                                </div>
                                <div :class="data.competitor_analysis ? 'glass p-4 rounded-xl border-purple-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Competitors
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.competitor_analysis ? '‚úÖ Scanned' : 'Waiting...'"></div>
                                </div>
                                <div :class="data.project_bible ? 'glass p-4 rounded-xl border-purple-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Project Bible
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.project_bible ? '‚úÖ Formulated' : 'Waiting...'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- DEPT 2: RESEARCH -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                <span
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Research</span>
                            </div>
                            <div class="space-y-3">
                                <div :class="data.research_deep ? 'glass p-4 rounded-xl border-blue-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Deep Scan
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.research_deep ? '‚úÖ Investigated' : 'Waiting...'"></div>
                                </div>
                                <div :class="data.research_verified ? 'glass p-4 rounded-xl border-blue-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Fact Checking
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.research_verified ? '‚úÖ Verified' : 'Waiting...'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- DEPT 3: NARRATIVE -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-2 h-2 rounded-full bg-pink-500"></div>
                                <span
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Narrative</span>
                            </div>
                            <div class="space-y-3">
                                <div :class="data.script_outline ? 'glass p-4 rounded-xl border-pink-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Outline</div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.script_outline ? '‚úÖ Architected' : 'Waiting...'"></div>
                                </div>
                                <div :class="data.script_final ? 'glass p-4 rounded-xl border-pink-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Final Script
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.script_final ? '‚úÖ Written' : 'Waiting...'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- DEPT 4: ART -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Art</span>
                            </div>
                            <div class="space-y-3">
                                <div :class="data.art_direction ? 'glass p-4 rounded-xl border-amber-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Art Style
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.art_direction ? '‚úÖ Defined' : 'Waiting...'"></div>
                                </div>
                                <div :class="data.visual_prompts ? 'glass p-4 rounded-xl border-amber-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Visual
                                        Prompts</div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.visual_prompts ? '‚úÖ Engineered' : 'Waiting...'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- DEPT 5: PRODUCTION -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                <span
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Production</span>
                            </div>
                            <div class="space-y-3">
                                <div :class="data.post_audio ? 'glass p-4 rounded-xl border-green-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">Voice & Audio
                                    </div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.post_audio ? '‚úÖ Synthesized' : 'Waiting...'"></div>
                                </div>
                                <div :class="data.post_seo ? 'glass p-4 rounded-xl border-green-500/50' : 'p-4 rounded-xl border border-[#222] opacity-40'"
                                    class="transition-all duration-500">
                                    <div class="text-[9px] uppercase tracking-tighter text-slate-500 mb-1">SEO &
                                        Metadata</div>
                                    <div class="text-xs font-bold text-white truncate"
                                        x-text="data.post_seo ? '‚úÖ Optimized' : 'Waiting...'"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div x-show="view === 'settings'" class="flex-1 p-8 overflow-y-auto z-10" x-transition>
                <div class="max-w-4xl mx-auto space-y-8">
                    <h2 class="text-2xl font-bold text-white mb-8">System Configuration</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Key Settings -->
                        <div class="glass p-6 rounded-2xl space-y-6">
                            <h3 class="text-sm font-bold text-purple-400 uppercase tracking-widest">Base Config</h3>

                            <div>
                                <label class="text-[10px] text-slate-500 uppercase block mb-2">Gemini API Key</label>
                                <input type="password" x-model="settings.api_key"
                                    class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-3 text-sm focus:border-purple-500 outline-none">
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-500 uppercase block mb-2">Interface
                                    Language</label>
                                <select x-model="settings.language" @change="updateLanguage()"
                                    class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-3 text-sm focus:border-purple-500 outline-none">
                                    <option value="es">Espa√±ol</option>
                                    <option value="en">English (Coming Soon)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Model Selection -->
                        <div class="glass p-6 rounded-2xl space-y-6">
                            <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest">Model Engine</h3>

                            <div>
                                <label class="text-[10px] text-slate-500 uppercase block mb-2">Fast Engine
                                    (Speed)</label>
                                <select x-model="settings.models.fast"
                                    class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-3 text-sm focus:border-purple-500 outline-none">
                                    <option value="gemini-3-flash-preview">Gemini 3 Flash (Latest & Fast)</option>
                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (Balanced)</option>
                                    <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (Ultra Fast)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-500 uppercase block mb-2">Research Engine (Deep
                                    reasoning)</label>
                                <select x-model="settings.models.research"
                                    class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-3 text-sm focus:border-purple-500 outline-none">
                                    <option value="gemini-3-pro-preview">Gemini 3 Pro (Most Intelligent)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (Stable Deep Reasoning)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-500 uppercase block mb-2">Advanced Image
                                    Engine</label>
                                <select x-model="settings.models.image"
                                    class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-3 text-sm focus:border-purple-500 outline-none">
                                    <option value="gemini-2.5-flash-image">Nano Banana (Fast & Efficient)</option>
                                    <option value="gemini-3-pro-image-preview">Nano Banana Pro (Professional Assets)
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Studio -->
                    <div class="glass p-6 rounded-2xl space-y-6">
                        <h3 class="text-sm font-bold text-green-400 uppercase tracking-widest">Voice Studio (Native TTS)
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase block mb-2">TTS Model</label>
                                <select x-model="settings.models.audio"
                                    class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-3 text-sm focus:border-purple-500 outline-none">
                                    <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash Preview TTS</option>
                                    <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro Preview TTS</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase block mb-2">Voice Tone</label>
                                <select x-model="settings.voice_name"
                                    class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-3 text-sm focus:border-purple-500 outline-none">
                                    <template x-for="v in voices">
                                        <option :value="v" x-text="v"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Prompts Customization -->
                    <div class="glass p-6 rounded-2xl">
                        <h3 class="text-sm font-bold text-pink-400 uppercase tracking-widest mb-6">Agent Instructions
                            (I18n)</h3>
                        <div class="space-y-4">
                            <template x-for="(agentData, agentId) in translations.agents">
                                <div class="border-b border-[#222] pb-6">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="text-sm font-bold text-slate-300" x-text="agentData.name"></div>
                                        <div class="text-[9px] text-slate-600 font-mono" x-text="agentId"></div>
                                    </div>
                                    <textarea x-model="agentData.prompt"
                                        class="w-full bg-[#050505] border border-[#2a2a2a] rounded-lg p-4 text-[11px] text-slate-400 focus:border-purple-500 outline-none min-h-[150px] font-mono leading-relaxed"
                                        @input="autoResize($el)"></textarea>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="flex justify-end pt-8">
                        <button @click="saveSettings()" :disabled="processing"
                            class="bg-purple-600 hover:bg-purple-500 text-white px-10 py-4 rounded-xl font-bold shadow-[0_0_30px_rgba(168,85,247,0.3)] transition-all">
                            SAVE GLOBAL CONFIGURATION
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: LIBRARY -->
            <div x-show="view === 'library'" class="flex-1 p-8 overflow-y-auto" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="proj in projects">
                        <div
                            class="glass rounded-2xl overflow-hidden hover:border-purple-500/50 transition-all group flex flex-col">
                            <div class="aspect-video bg-[#0f0f0f] relative overflow-hidden">
                                <template x-if="proj.metadata?.thumbnail_file">
                                    <img :src="'/images/' + proj.metadata.thumbnail_file"
                                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                                </template>
                                <div class="absolute inset-0 bg-gradient-to-t from-[#050505] to-transparent opacity-60">
                                </div>
                                <div class="absolute bottom-4 left-4">
                                    <div class="text-[10px] text-purple-400 font-bold uppercase tracking-widest"
                                        x-text="proj.niche"></div>
                                    <div class="text-sm font-bold text-white truncate max-w-[200px]"
                                        x-text="proj.topic"></div>
                                </div>
                            </div>
                            <div class="p-4 flex-1 flex flex-col justify-between">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-[10px] text-slate-500"
                                        x-text="new Date(proj.date).toLocaleDateString()"></div>
                                    <div class="flex gap-2">
                                        <button @click="editProject(proj)"
                                            class="p-2 bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 rounded-lg transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                                </path>
                                            </svg>
                                        </button>
                                        <button @click="deleteProject(proj.id)"
                                            class="p-2 bg-red-600/20 hover:bg-red-600/40 text-red-300 rounded-lg transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- VIEW: EDITOR -->
            <div x-show="view === 'editor' && currentProject" class="flex-1 flex flex-col h-full bg-[#050505]"
                x-transition>
                <template x-if="currentProject">
                    <div class="flex-1 flex flex-col h-full">
                        <div
                            class="h-16 border-b border-[#1a1a1a] flex items-center justify-between px-8 bg-[#0a0a0a]/80 backdrop-blur">
                            <div class="flex items-center gap-4">
                                <button @click="view = 'library'"
                                    class="text-slate-400 hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>
                                <div>
                                    <div class="text-[10px] text-purple-400 font-bold uppercase tracking-widest">Editor
                                        Mode
                                    </div>
                                    <div class="text-sm font-bold text-white" x-text="currentProject.topic"></div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button @click="runAudit()" :disabled="processing"
                                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold transition-all disabled:opacity-50">
                                    üîç AUDIT PROJECT
                                </button>
                                <button @click="runAutoFix()" :disabled="processing"
                                    class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded text-xs font-bold transition-all disabled:opacity-50">
                                    ü™Ñ AUTO-FIX
                                </button>
                                <button @click="saveProject()"
                                    class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded text-xs font-bold transition-all">
                                    üíæ SAVE CHANGES
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-hidden flex">
                            <!-- Script Sections -->
                            <div class="flex-1 overflow-y-auto p-12 custom-scrollbar">
                                <div class="max-w-4xl mx-auto space-y-12">
                                    <template x-for="(block, idx) in currentProject.script">
                                        <div class="relative group">
                                            <div class="absolute -left-12 top-0 text-[10px] font-bold text-slate-700 select-none"
                                                x-text="'#' + (idx + 1)"></div>
                                            <div class="flex gap-8">
                                                <div class="flex-1 space-y-4">
                                                    <div class="flex items-center justify-between">
                                                        <input type="text" x-model="block.section"
                                                            class="bg-transparent text-purple-400 font-bold text-xs uppercase tracking-widest border-none outline-none focus:ring-0">
                                                        <div class="flex gap-2">
                                                            <button @click="expandBlock(idx)"
                                                                class="text-[10px] text-slate-500 hover:text-purple-400 uppercase tracking-widest font-bold transition-colors">Expand</button>
                                                            <button @click="refineBlock(idx)"
                                                                class="text-[10px] text-slate-500 hover:text-blue-400 uppercase tracking-widest font-bold transition-colors">Refine</button>
                                                        </div>
                                                    </div>
                                                    <textarea x-model="block.audio_text"
                                                        class="w-full bg-transparent text-slate-200 border-none focus:ring-0 resize-none leading-relaxed text-lg"
                                                        rows="5" @input="autoResize($el)"></textarea>

                                                    <div class="pt-4 border-t border-[#1a1a1a] flex gap-4">
                                                        <div
                                                            class="w-1/3 aspect-video glass rounded-xl overflow-hidden relative group/img">
                                                            <template
                                                                x-if="block.generated_images && block.generated_images.length">
                                                                <img :src="'/images/' + block.generated_images[0]"
                                                                    class="w-full h-full object-cover">
                                                            </template>
                                                            <div
                                                                class="absolute inset-0 bg-black/60 opacity-0 group-hover/img:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                                                <button @click="regenBlockImgs(idx)"
                                                                    class="p-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">üîÑ</button>
                                                                <label
                                                                    class="p-2 bg-white/10 hover:bg-white/20 rounded-lg text-white cursor-pointer">
                                                                    üìÅ <input type="file"
                                                                        @change="uploadBlockImg(idx, $event)"
                                                                        class="hidden">
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="flex-1">
                                                            <div class="text-[10px] text-slate-500 uppercase mb-2">
                                                                Visual
                                                                Direction</div>
                                                            <textarea x-model="block.visual_prompt"
                                                                class="w-full bg-[#0a0a0a] border border-[#1a1a1a] rounded-lg p-3 text-[11px] text-slate-400 focus:border-purple-500 outline-none resize-none"
                                                                rows="3"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Sidebar: Audit Reports & Metadata -->
                            <aside class="w-96 border-l border-[#1a1a1a] flex flex-col bg-[#0a0a0a]">
                                <div class="p-6 border-b border-[#1a1a1a]">
                                    <h3 class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-6">Metadata
                                        & SEO
                                    </h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-[9px] uppercase text-slate-600 block mb-1">Title</label>
                                            <input type="text" x-model="currentProject.metadata.title"
                                                class="w-full bg-[#151515] border border-[#2a2a2a] rounded p-2 text-xs text-slate-300 focus:border-purple-500 outline-none">
                                        </div>
                                        <div>
                                            <label class="text-[9px] uppercase text-slate-600 block mb-1">Tags</label>
                                            <textarea x-model="currentProject.metadata.tags"
                                                class="w-full bg-[#151515] border border-[#2a2a2a] rounded p-2 text-[10px] text-slate-400 focus:border-purple-500 outline-none"
                                                rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- COMPETITOR ANALYSIS -->
                                <div class="p-6 border-b border-[#1a1a1a]">
                                    <h3 class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-4">
                                        Competitor
                                        Analysis</h3>
                                    <div class="space-y-3">
                                        <template
                                            x-if="currentProject.competitor_analysis && currentProject.competitor_analysis.length">
                                            <template x-for="comp in currentProject.competitor_analysis">
                                                <div class="p-3 bg-[#111] border border-[#222] rounded-lg">
                                                    <div class="flex items-center justify-between mb-1">
                                                        <div class="text-[10px] font-bold text-white truncate max-w-[150px]"
                                                            x-text="comp.title"></div>
                                                        <a :href="comp.link" target="_blank"
                                                            class="text-[9px] text-purple-400 hover:underline">Link</a>
                                                    </div>
                                                    <div
                                                        class="flex items-center justify-between text-[8px] text-slate-500 mb-2">
                                                        <span x-text="comp.views"></span>
                                                        <span x-text="comp.published_date"></span>
                                                    </div>
                                                    <div class="text-[9px] text-slate-400 leading-tight italic"
                                                        x-text="'Strategy: ' + comp.winning_strategy"></div>
                                                </div>
                                            </template>
                                        </template>
                                        <template
                                            x-if="!currentProject.competitor_analysis || !currentProject.competitor_analysis.length">
                                            <div class="text-[10px] text-slate-700 italic">No competitors analyzed yet.
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <div class="flex-1 overflow-y-auto p-6 scrollbar-hide">
                                    <h3 class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-4">Audit
                                        Reports
                                    </h3>
                                    <template x-if="currentProject.audit_report">
                                        <div class="space-y-4">
                                            <div class="p-4 rounded-xl border border-blue-500/20 bg-blue-500/5">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-xs font-bold text-blue-400">Panel Score</span>
                                                    <span class="text-xl font-bold text-blue-400"
                                                        x-text="currentProject.audit_report.global_score + '/10'"></span>
                                                </div>
                                                <div class="text-[10px] text-blue-300 italic"
                                                    x-text="currentProject.audit_report.global_verdict"></div>
                                            </div>

                                            <div class="space-y-2">
                                                <template x-for="sugg in currentProject.audit_report.suggestions">
                                                    <div class="p-3 bg-[#111] border border-[#222] rounded-lg text-[10px] text-slate-400 leading-relaxed"
                                                        x-text="sugg"></div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="!currentProject.audit_report">
                                        <div
                                            class="flex flex-col items-center justify-center py-12 text-slate-700 italic text-xs text-center px-4">
                                            <svg class="w-8 h-8 mb-3 opacity-20" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Run audit to generate quality report
                                        </div>
                                    </template>
                                </div>
                            </aside>
                        </div>
                    </div>
                </template>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="border-t border-[#1a1a1a] bg-[#050505] py-4 px-6 text-center text-[10px] text-slate-500">
            <div class="flex items-center justify-center gap-4">
                <span>Neural Swarm v2.0</span>
                <span class="text-slate-800">|</span>
                <span>Created by <a href="https://github.com/monrroyag" target="_blank"
                        class="text-purple-400 hover:text-purple-300 transition-colors">Agust√≠n Arellano</a></span>
            </div>
        </footer>

    </div>

    <script>
        function swarmApp() {
            return {
                view: 'swarm',
                niche: 'Futuristic AI Trends',
                processing: false,
                logs: [],
                projects: [],
                currentProject: null,
                data: {
                    trends: null, audience_profile: null, competitor_analysis: null, project_bible: null,
                    research_deep: null, research_human: null, research_verified: null,
                    script_outline: null, raw_script: null, script_hook: null,
                    script_final: null, art_direction: null, visual_prompts: null,
                    thumbnail_concept: null, post_audio: null, post_seo: null
                },
                settings: {
                    api_key: '',
                    language: 'es',
                    models: { text: '', research: '', image: '', audio: '' }
                },
                translations: { ui: {}, agents: {} },
                voices: [
                    'Zephyr', 'Puck', 'Charon', 'Kore', 'Fenrir', 'Leda', 'Orus', 'Aoede',
                    'Callirrhoe', 'Autonoe', 'Enceladus', 'Iapetus', 'Umbriel', 'Algieba',
                    'Despina', 'Erinome', 'Algenib', 'Rasalgethi', 'Laomedeia', 'Achernar',
                    'Alnilam', 'Schedar', 'Gacrux', 'Pulcherrima', 'Achird', 'Zubenelgenubi',
                    'Vindemiatrix', 'Sadachbia', 'Sadaltager', 'Sulafat'
                ],

                init() {
                    this.connectWS();
                    this.loadSettings();
                    this.loadProjects();
                    this.logs.push({ timestamp: new Date().toLocaleTimeString(), message: "Neural Swarm System initialized.", type: "info" });
                },

                async loadProjects() {
                    try {
                        const res = await fetch('/api/projects');
                        this.projects = await res.json();
                    } catch (e) {
                        console.error("Failed to load projects", e);
                    }
                },

                async loadSettings() {
                    try {
                        const res = await fetch('/api/settings');
                        this.settings = await res.json();
                        await this.loadTranslations(this.settings.language);
                    } catch (e) { console.error("Load settings failed", e); }
                },

                async loadTranslations(lang) {
                    try {
                        const res = await fetch(`/api/i18n/${lang}`);
                        this.translations = await res.json();
                    } catch (e) { console.error("Load i18n failed", e); }
                },

                async saveSettings() {
                    this.processing = true;
                    try {
                        // First save settings
                        await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.settings)
                        });

                        // We could also allow saving edited translations back if needed, 
                        // but for now let's focus on the global settings.
                        // Actually, let's just use the settings to change behavior.

                        this.logs.unshift({ timestamp: new Date().toLocaleTimeString(), message: "Settings saved and applied.", type: "success" });
                    } finally {
                        this.processing = false;
                    }
                },

                updateLanguage() {
                    this.loadTranslations(this.settings.language);
                },

                async deleteProject(id) {
                    if (!confirm("Delete this project?")) return;
                    await fetch(`/api/projects/${id}`, { method: 'DELETE' });
                    this.loadProjects();
                },

                editProject(proj) {
                    this.currentProject = JSON.parse(JSON.stringify(proj)); // Deep clone
                    this.view = 'editor';
                    this.$nextTick(() => {
                        document.querySelectorAll('textarea').forEach(el => this.autoResize(el));
                    });
                },

                async saveProject() {
                    await fetch(`/api/projects/${this.currentProject.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.currentProject)
                    });
                    this.logs.unshift({ timestamp: new Date().toLocaleTimeString(), message: "Project saved successfully.", type: "success" });
                    this.loadProjects();
                },

                async runAudit() {
                    this.processing = true;
                    try {
                        const res = await fetch(`/api/projects/${this.currentProject.id}/audit_panel`, { method: 'POST' });
                        this.currentProject = await res.json();
                    } finally {
                        this.processing = false;
                    }
                },

                async runAutoFix() {
                    this.processing = true;
                    const instruction = prompt("Optional instructions for Auto-Fix (leave blank to use audit report):");
                    try {
                        const res = await fetch(`/api/projects/${this.currentProject.id}/autofix`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instruction })
                        });
                        this.currentProject = await res.json();
                    } finally {
                        this.processing = false;
                    }
                },

                async expandBlock(idx) {
                    const block = this.currentProject.script[idx];
                    const res = await fetch('/api/editor/expand', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: block.audio_text, context: this.currentProject.topic })
                    });
                    const data = await res.json();
                    block.audio_text = data.text;
                },

                async refineBlock(idx) {
                    const block = this.currentProject.script[idx];
                    const instruction = prompt("Refinement instruction:", "Improve flow and tone.");
                    if (!instruction) return;
                    const res = await fetch(`/api/projects/${this.currentProject.id}/block/${idx}/refine`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instruction })
                    });
                    const data = await res.json();
                    block.audio_text = data.text;
                },

                async regenBlockImgs(idx) {
                    const res = await fetch(`/api/projects/${this.currentProject.id}/images/block/${idx}`, { method: 'POST' });
                    const data = await res.json();
                    this.currentProject.script[idx].generated_images = data.images;
                },

                async uploadBlockImg(idx, event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const formData = new FormData();
                    formData.append('file', file);
                    const res = await fetch(`/api/projects/${this.currentProject.id}/upload/block/${idx}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    this.currentProject.script[idx].generated_images.unshift(data.file);
                },

                autoResize(el) {
                    el.style.height = 'auto';
                    el.style.height = el.scrollHeight + 'px';
                },

                connectWS() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const ws = new WebSocket(`${protocol}//${window.location.host}/ws/logs`);
                    ws.onmessage = (event) => {
                        const payload = JSON.parse(event.data);

                        // Log Handling
                        this.logs.unshift({
                            timestamp: payload.timestamp || new Date().toLocaleTimeString(),
                            message: payload.message,
                            type: payload.type || 'info'
                        });
                        if (this.logs.length > 100) this.logs.pop();

                        // Data Update Handling
                        if (payload.type === 'data_update') {
                            const step = payload.payload.step;
                            const content = payload.payload.data;

                            // Map step ID to data property
                            const mapping = {
                                "trends": "trends",
                                "audience": "audience_profile",
                                "competitors": "competitor_analysis",
                                "bible": "project_bible",
                                "research_deep": "research_deep",
                                "research_human": "research_human",
                                "research_verified": "research_verified",
                                "script_outline": "script_outline",
                                "script_raw": "raw_script",
                                "script_hook": "script_hook",
                                "script_final": "script_final",
                                "art_direction": "art_direction",
                                "art_prompts": "visual_prompts",
                                "art_thumbnail": "thumbnail_concept",
                                "post_audio": "post_audio",
                                "post_seo": "post_seo"
                            };

                            if (mapping[step]) {
                                this.data[mapping[step]] = content;
                            }
                        }
                    };

                    ws.onclose = () => {
                        this.logs.push({ timestamp: new Date().toLocaleTimeString(), message: "Connection lost. Reconnecting...", type: "error" });
                        setTimeout(() => this.connectWS(), 2000);
                    };
                },

                async startSwarm() {
                    this.processing = true;
                    this.logs.unshift({ timestamp: new Date().toLocaleTimeString(), message: "üöÄ IGNITION SEQUENCE STARTED", type: "info" });

                    // Clear previous data
                    Object.keys(this.data).forEach(key => this.data[key] = null);

                    try {
                        await fetch('/api/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ niche: this.niche })
                        });
                    } catch (e) {
                        this.logs.unshift({ timestamp: new Date().toLocaleTimeString(), message: "Start failed: " + e, type: "error" });
                    } finally {
                        this.processing = false;
                    }
                }
            }
        }
    </script>
</body>

</html>